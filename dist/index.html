<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Elm app</title>
    <link rel="stylesheet" type="text/css" href="semantic.min.css">
    <style media="all">
    body {
        background-color: #FFFFFF;
    }
    .ui.menu .item img.logo {
        margin-right: 1.5em;
    }
    .main.container {
        margin-top: 7em;
    }

    div.ui.message {
        margin-top: 7em;
    }

    .ui.footer.segment {
        margin: 5em 0em 0em;
        padding: 5em 0em;
    }

    span.labels span
    {
        margin-left:5px;
    }

    span.labels span.green {
        background-color:green;
        color:green;
    }

    span.labels span.yellow {
        background-color:yellow;
        color:yellow;
    }

    span.labels span.orange {
        background-color:orange;
        color:orange;
    }

    span.labels span.red {
        background-color:red;
        color:red;
    }

    span.labels span.purple {
        background-color:purple;
        color:purple;
    }

    span.labels span.blue {
        background-color:blue;
        color:blue;
    }

    span.labels span.pink {
        background-color:pink;
        color:pink;
    }

    span.labels span.black {
        background-color:black;
        color:black;
    }

    span.labels span.gray {
        background-color:gray;
        color:gray;
    }
    </style>
</head>

<body>
    <div id="app"></div>

    <script src="bundle.js"></script>
    <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
    <script src="client.js"></script>
    <script src="semantic.min.js"></script>

    <script>
    var app = Elm.Main.fullscreen();

    var successMessage = function(text)
    {
        message = {
            messageClass: "positive",
            header: "Success",
            text: text,
            active: true
        }
        app.ports.portMessage.send(message)
    }

    var errorMessage = function(text)
    {
        message = {
            messageClass: "negative",
            header: "Error",
            text: text,
            active: true
        }
        app.ports.portMessage.send(message)
    }


    app.ports.authorizeTrello.subscribe(function(){
        Trello.authorize({
          type: 'popup',
          name: 'Elm Trello',
          scope: {
            read: 'true',
            write: 'true' },
          expiration: 'never',
          success: function() { app.ports.trelloAuthorized.send("Trello successfully authorized!") },
          error: function() { errorMessage("Authentication failed") }
        })
    });

    app.ports.deauthorizeTrello.subscribe(function(){
        Trello.deauthorize()
    });

    app.ports.loadBoards.subscribe(function() {
        Trello.get(
            '/members/me/boards/?filter=open&fields=id&fields=name',
            loadedBoards,
            function() { console.log("Failed to load boards"); }
        );
    })

    app.ports.loadLists.subscribe(function(boardId) {
        Trello.get(
            '/boards/'+boardId+"/lists?cards=open&card_fields=name&card_fields=labels",
            loadedLists,
            function() { console.log("Failed to load lists"); }
        );
    })

    app.ports.loadLabels.subscribe(function(boardId) {
        Trello.get(
            '/boards/'+boardId+"/labels",
            loadedLabels,
            function() { console.log("Failed to load labels"); }
        );
    })

    var loadedBoards = function(boards) {
        var boardsArray = []
        for(i = 0; i < boards.length ; i++)
        {
            var board = boards[i]
            var labels = []



            boardsArray.push(
                {
                    id: board.id,
                    name: board.name,
                    lists : [],
                    labels : labels
                }
            )
        }

        app.ports.boardsLoaded.send(boardsArray)
        // app.ports.boardsLoaded.send(boards),
    }

    var loadedLists = function(lists) {
        // console.log(lists)
        var listsArray = []
        var idBoard = lists.length > 0 ? lists[0].idBoard : ""
        for(i = 0; i < lists.length ; i++)
        {
            var list = lists[i]
            var cards = []

            for(j=0; j<list.cards.length; j++)
            {
                var card = list.cards[j]
                var labels = []

                for(k=0; k < card.labels.length; k++)
                {
                    var label = card.labels[k]
                    labels.push({
                        color: label.color ? label.color : "gray",
                        name: label.name
                    })
                }

                cards.push({
                    id: card.id,
                    name: card.name,
                    labels: labels
                })
            }


            listsArray.push(
                {
                    id: list.id,
                    name: list.name,
                    cards : cards
                }
            )


        }

        if(idBoard == "5728a464125d32598f5021f9")
        {
            console.log({ trelloList: listsArray, boardId: idBoard })
        }

        app.ports.listsLoaded.send({ trelloList: listsArray, boardId: idBoard })
        // app.ports.boardsLoaded.send(boards),
    }

    var loadedLabels = function(labels) {
        // console.log(lists)
        var labelsArray = []
        var idBoard = labels.length > 0 ? labels[0].idBoard : ""
        for(i = 0; i < labels.length ; i++)
        {
            var label = labels[i]
            var cards = []

            if(label.name.length > 0)
            {
                labelsArray.push(
                    {
                        color: label.color ? label.color : "gray",
                        name: label.name
                    }
                )
            }

        }

        if(idBoard == "5728a464125d32598f5021f9")
        {
            console.log({ trelloLabel: labelsArray, boardId: idBoard })
        }
        app.ports.labelsLoaded.send({ trelloLabel: labelsArray, boardId: idBoard })
        // app.ports.boardsLoaded.send(boards),
    }


    // var myList = "57bf6052835199ceee54009b";
    // var creationSuccess = function(data) {
    //   console.log('Card created successfully. Data returned:' + JSON.stringify(data));
    // };
    // var newCard = {
    //   name: 'New Test Card',
    //   desc: 'This is the description of our new card.',
    //   // Place this card at the top of our list
    //   idList: myList,
    //   pos: 'top'
    // };
    // Trello.post('/cards/', newCard, creationSuccess);

    </script>
</body>

</html>
